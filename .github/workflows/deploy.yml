- name: Build and run containers
  env:
    SSH_USER: ${{ secrets.SSH_USER }}
    SSH_HOST: ${{ secrets.SSH_HOST }}

    NODE_ENV: production
    SESSION_SECRET: ${{ secrets.SESSION_SECRET }}
    PEPPER: ${{ secrets.PEPPER }}
    NEXT_PUBLIC_SITE_NAME: ${{ secrets.NEXT_PUBLIC_SITE_NAME }}
    NEXT_PUBLIC_BASE_URL: ${{ secrets.NEXT_PUBLIC_BASE_URL }}

    POSTGRES_HOST: ${{ secrets.POSTGRES_HOST }}
    POSTGRES_PORT: ${{ secrets.POSTGRES_PORT }}
    POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
    POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
    POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}

    EMAIL_SMTP_HOST: ${{ secrets.EMAIL_SMTP_HOST }}
    EMAIL_SMTP_PORT: ${{ secrets.EMAIL_SMTP_PORT }}
    EMAIL_SMTP_USER: ${{ secrets.EMAIL_SMTP_USER }}
    EMAIL_SMTP_PASSWORD: ${{ secrets.EMAIL_SMTP_PASSWORD }}

    CLOUDINARY_CLOUD_NAME: ${{ secrets.CLOUDINARY_CLOUD_NAME }}
    CLOUDINARY_API_KEY: ${{ secrets.CLOUDINARY_API_KEY }}
    CLOUDINARY_API_SECRET: ${{ secrets.CLOUDINARY_API_SECRET }}

  run: |
    ssh -T $SSH_USER@$SSH_HOST << 'EOF'
set -e

cd /var/www/indies

echo "ðŸ“ Criando .env.production"
cat > .env.production <<EOL
NODE_ENV=production

SESSION_SECRET=$SESSION_SECRET
PEPPER=$PEPPER
NEXT_PUBLIC_SITE_NAME=$NEXT_PUBLIC_SITE_NAME
NEXT_PUBLIC_BASE_URL=$NEXT_PUBLIC_BASE_URL

POSTGRES_HOST=$POSTGRES_HOST
POSTGRES_PORT=$POSTGRES_PORT
POSTGRES_DB=$POSTGRES_DB
POSTGRES_USER=$POSTGRES_USER
POSTGRES_PASSWORD=$POSTGRES_PASSWORD

EMAIL_SMTP_HOST=$EMAIL_SMTP_HOST
EMAIL_SMTP_PORT=$EMAIL_SMTP_PORT
EMAIL_SMTP_USER=$EMAIL_SMTP_USER
EMAIL_SMTP_PASSWORD=$EMAIL_SMTP_PASSWORD

CLOUDINARY_CLOUD_NAME=$CLOUDINARY_CLOUD_NAME
CLOUDINARY_API_KEY=$CLOUDINARY_API_KEY
CLOUDINARY_API_SECRET=$CLOUDINARY_API_SECRET
EOL

echo "ðŸ³ Docker compose build"
docker compose build

echo "ðŸš€ Docker compose up"
docker compose up -d

echo "âœ… Deploy finalizado"
EOF
