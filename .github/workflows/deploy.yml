name: Deploy Indies Brasil

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    # üëâ IMPORTANTE: habilita secrets do Environment "production"
    environment: production

    steps:
      # 1Ô∏è‚É£ Checkout do c√≥digo
      - name: Checkout
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11

      # 2Ô∏è‚É£ Setup do SSH Agent (com SHA fixo)
      - name: Setup SSH
        uses: webfactory/ssh-agent@a6f90b1f127823b31d4d4a8d96047790581349bd
        with:
          ssh-private-key: ${{ secrets.SSH_KEY }}

      # 3Ô∏è‚É£ (DEBUG TEMPOR√ÅRIO) Verifica se SSH_HOST existe e resolve DNS
      # ‚ö†Ô∏è Pode remover depois que funcionar
      - name: Debug SSH host
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
        run: |
          if [ -z "$SSH_HOST" ]; then
            echo "‚ùå SSH_HOST est√° vazio"
            exit 1
          fi

          echo "üîç Tentando resolver SSH_HOST: $SSH_HOST"
          getent hosts "$SSH_HOST" || {
            echo "‚ùå Falha ao resolver DNS para SSH_HOST"
            exit 1
          }

          echo "‚úÖ SSH_HOST resolvido com sucesso"

      # 4Ô∏è‚É£ Deploy na VPS
      - name: Deploy to VPS
        env:
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_HOST: ${{ secrets.SSH_HOST }}

          # App
          NODE_ENV: production
          SESSION_SECRET: ${{ secrets.SESSION_SECRET }}
          PEPPER: ${{ secrets.PEPPER }}
          NEXT_PUBLIC_SITE_NAME: ${{ secrets.NEXT_PUBLIC_SITE_NAME }}
          NEXT_PUBLIC_BASE_URL: ${{ secrets.NEXT_PUBLIC_BASE_URL }}

          # Database
          POSTGRES_HOST: ${{ secrets.POSTGRES_HOST }}
          POSTGRES_PORT: ${{ secrets.POSTGRES_PORT }}
          POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

          # Email
          EMAIL_SMTP_HOST: ${{ secrets.EMAIL_SMTP_HOST }}
          EMAIL_SMTP_PORT: ${{ secrets.EMAIL_SMTP_PORT }}
          EMAIL_SMTP_USER: ${{ secrets.EMAIL_SMTP_USER }}
          EMAIL_SMTP_PASSWORD: ${{ secrets.EMAIL_SMTP_PASSWORD }}

          # Upload / Cloudinary
          FILE_UPLOAD_BASE_FOLDER: ${{ secrets.FILE_UPLOAD_BASE_FOLDER }}
          CLOUDINARY_CLOUD_NAME: ${{ secrets.CLOUDINARY_CLOUD_NAME }}
          CLOUDINARY_API_KEY: ${{ secrets.CLOUDINARY_API_KEY }}
          CLOUDINARY_API_SECRET: ${{ secrets.CLOUDINARY_API_SECRET }}

        run: |
          ssh -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST << 'EOF'
            set -e

            echo "üìÇ Indo para o diret√≥rio do projeto"
            cd /var/www/indies || exit 1

            echo "‚¨áÔ∏è Atualizando c√≥digo"
            git pull origin main

            echo "üìù Gerando .env.production"
            cat > .env.production << EOL
            NODE_ENV=production

            SESSION_SECRET=$SESSION_SECRET
            PEPPER=$PEPPER
            NEXT_PUBLIC_SITE_NAME=$NEXT_PUBLIC_SITE_NAME
            NEXT_PUBLIC_BASE_URL=$NEXT_PUBLIC_BASE_URL

            POSTGRES_HOST=$POSTGRES_HOST
            POSTGRES_PORT=$POSTGRES_PORT
            POSTGRES_DB=$POSTGRES_DB
            POSTGRES_USER=$POSTGRES_USER
            POSTGRES_PASSWORD=$POSTGRES_PASSWORD
            DATABASE_URL=$DATABASE_URL

            EMAIL_SMTP_HOST=$EMAIL_SMTP_HOST
            EMAIL_SMTP_PORT=$EMAIL_SMTP_PORT
            EMAIL_SMTP_USER=$EMAIL_SMTP_USER
            EMAIL_SMTP_PASSWORD=$EMAIL_SMTP_PASSWORD

            FILE_UPLOAD_BASE_FOLDER=$FILE_UPLOAD_BASE_FOLDER

            CLOUDINARY_CLOUD_NAME=$CLOUDINARY_CLOUD_NAME
            CLOUDINARY_API_KEY=$CLOUDINARY_API_KEY
            CLOUDINARY_API_SECRET=$CLOUDINARY_API_SECRET
            EOL

            echo "üê≥ Buildando containers"
            docker compose build

            echo "üöÄ Subindo containers"
            docker compose up -d

            echo "üßπ Limpando imagens antigas"
            docker image prune -f
          EOF
