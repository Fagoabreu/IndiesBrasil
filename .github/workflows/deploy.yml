name: Deploy Indies Brasil

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: Production

    steps:
      # 1Ô∏è‚É£ Checkout do c√≥digo
      - name: Checkout
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11

      # 2Ô∏è‚É£ SSH Agent
      - name: Setup SSH
        uses: webfactory/ssh-agent@a6f90b1f127823b31d4d4a8d96047790581349bd
        with:
          ssh-private-key: ${{ secrets.SSH_KEY }}

      # 3Ô∏è‚É£ Registrar host (necess√°rio para rsync)
      - name: Add VPS to known_hosts
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H "$SSH_HOST" >> ~/.ssh/known_hosts

      # 4Ô∏è‚É£ Enviar c√≥digo para VPS
      - name: Sync project to VPS
        env:
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_HOST: ${{ secrets.SSH_HOST }}
        run: |
          rsync -az --delete \
            --filter=':- .dockerignore' \
            ./ \
            $SSH_USER@$SSH_HOST:/var/www/indies

      # 5Ô∏è‚É£ Build e deploy via Docker Compose
      - name: Build and run containers
        env:
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_HOST: ${{ secrets.SSH_HOST }}

          NODE_ENV: production
          SESSION_SECRET: ${{ secrets.SESSION_SECRET }}
          PEPPER: ${{ secrets.PEPPER }}
          NEXT_PUBLIC_SITE_NAME: ${{ secrets.NEXT_PUBLIC_SITE_NAME }}
          NEXT_PUBLIC_BASE_URL: ${{ secrets.NEXT_PUBLIC_BASE_URL }}

          POSTGRES_HOST: ${{ secrets.POSTGRES_HOST }}
          POSTGRES_PORT: ${{ secrets.POSTGRES_PORT }}
          POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}

          EMAIL_SMTP_HOST: ${{ secrets.EMAIL_SMTP_HOST }}
          EMAIL_SMTP_PORT: ${{ secrets.EMAIL_SMTP_PORT }}
          EMAIL_SMTP_USER: ${{ secrets.EMAIL_SMTP_USER }}
          EMAIL_SMTP_PASSWORD: ${{ secrets.EMAIL_SMTP_PASSWORD }}

          CLOUDINARY_CLOUD_NAME: ${{ secrets.CLOUDINARY_CLOUD_NAME }}
          CLOUDINARY_API_KEY: ${{ secrets.CLOUDINARY_API_KEY }}
          CLOUDINARY_API_SECRET: ${{ secrets.CLOUDINARY_API_SECRET }}

        run: |
          ssh -T $SSH_USER@$SSH_HOST << 'EOF'
            set -e
            cd /var/www/indies

            echo "üìù Criando .env.production"

            : > .env.production
            chmod 600 .env.production
            printf "NODE_ENV=%s\n" "$NODE_ENV" >> .env.production
            printf "SESSION_SECRET=%s\n" "$SESSION_SECRET" >> .env.production
            printf "PEPPER=%s\n" "$PEPPER" >> .env.production
            printf "NEXT_PUBLIC_SITE_NAME=%s\n" "$NEXT_PUBLIC_SITE_NAME" >> .env.production
            printf "NEXT_PUBLIC_BASE_URL=%s\n" "$NEXT_PUBLIC_BASE_URL" >> .env.production

            printf "POSTGRES_HOST=%s\n" "$POSTGRES_HOST" >> .env.production
            printf "POSTGRES_PORT=%s\n" "$POSTGRES_PORT" >> .env.production
            printf "POSTGRES_DB=%s\n" "$POSTGRES_DB" >> .env.production
            printf "POSTGRES_USER=%s\n" "$POSTGRES_USER" >> .env.production
            printf "POSTGRES_PASSWORD=%s\n" "$POSTGRES_PASSWORD" >> .env.production

            printf "EMAIL_SMTP_HOST=%s\n" "$EMAIL_SMTP_HOST" >> .env.production
            printf "EMAIL_SMTP_PORT=%s\n" "$EMAIL_SMTP_PORT" >> .env.production
            printf "EMAIL_SMTP_USER=%s\n" "$EMAIL_SMTP_USER" >> .env.production
            printf "EMAIL_SMTP_PASSWORD=%s\n" "$EMAIL_SMTP_PASSWORD" >> .env.production

            printf "CLOUDINARY_CLOUD_NAME=%s\n" "$CLOUDINARY_CLOUD_NAME" >> .env.production
            printf "CLOUDINARY_API_KEY=%s\n" "$CLOUDINARY_API_KEY" >> .env.production
            printf "CLOUDINARY_API_SECRET=%s\n" "$CLOUDINARY_API_SECRET" >> .env.production

            echo "üê≥ Docker compose build"
            docker compose build

            echo "üöÄ Docker compose up"
            docker compose up -d

            echo "‚úÖ Deploy finalizado"
          EOF
