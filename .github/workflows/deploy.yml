name: Deploy Indies Brasil

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 1Ô∏è‚É£ Build da imagem
      - name: Build image
        run: |
          docker build -t indies-app:latest .

      # 2Ô∏è‚É£ Exportar imagem
      - name: Export image
        run: docker save indies-app:latest | gzip > indies-app.tar.gz

      # 3Ô∏è‚É£ Gerar .env.production (APP)
      - name: Generate app env
        run: |
          {

            echo "NODE_ENV=production"
            echo "CERTBOT_ENV=production"
            echo "CERTBOT_DOMAIN=${{ vars.CERTBOT_DOMAIN }}"
            echo "CERTBOT_EMAIL=${{ vars.EMAIL_SMTP_USER }}"
            echo "NEXT_PUBLIC_SITE_NAME=${{ vars.NEXT_PUBLIC_SITE_NAME }}"
            echo "NEXT_PUBLIC_BASE_URL=${{ vars.NEXT_PUBLIC_BASE_URL }}"
            echo "PEPPER=${{ secrets.PEPPER }}"
            echo "POSTGRES_HOST=${{ vars.POSTGRES_HOST }}"
            echo "POSTGRES_PORT=${{ vars.POSTGRES_PORT }}"
            echo "POSTGRES_DB=${{ vars.POSTGRES_DB }}"
            echo "POSTGRES_USER=${{ vars.POSTGRES_USER }}"
            echo "POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}"
            echo "POSTGRES_CA_PATH=${{ vars.POSTGRES_CA_PATH }}"
            echo "EMAIL_SMTP_HOST=${{ vars.EMAIL_SMTP_HOST }}"
            echo "EMAIL_SMTP_PORT=${{ vars.EMAIL_SMTP_PORT }}"
            echo "EMAIL_SMTP_USER=${{ vars.EMAIL_SMTP_USER }}"
            echo "EMAIL_SMTP_PASSWORD=${{ secrets.EMAIL_SMTP_PASSWORD }}"
            echo "CLOUDINARY_CLOUD_NAME=${{ vars.CLOUDINARY_CLOUD_NAME }}"
            echo "CLOUDINARY_API_KEY=${{ secrets.CLOUDINARY_API_KEY }}"
            echo "CLOUDINARY_API_SECRET=${{ secrets.CLOUDINARY_API_SECRET }}"
            echo "FILE_UPLOAD_BASE_FOLDER=${{ vars.FILE_UPLOAD_BASE_FOLDER }}"
          } > .env.production

      # 4Ô∏è‚É£ Configurar SSH
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_KEY }}

      # Pretara pastas
      - name: Prepare directories on server
        run: |
          ssh -o StrictHostKeyChecking=no ${{ vars.SSH_USER }}@${{ vars.SSH_HOST }} <<EOF
            mkdir -p /var/www/indies/nginx
            mkdir -p /var/www/indies/certs
          EOF

      #Enviar arquivos
      - name: Upload app artifacts
        run: |
          rsync -az --checksum \
            --exclude='certs/' \
            -e "ssh -o StrictHostKeyChecking=no" \
            indies-app.tar.gz \
            .env.production \
            deploy/compose.yaml \
            ${{ vars.SSH_USER }}@${{ vars.SSH_HOST }}:/var/www/indies/
            
          rsync -az --checksum \
            -e "ssh -o StrictHostKeyChecking=no" \
            deploy/nginx/ \
            ${{ vars.SSH_USER }}@${{ vars.SSH_HOST }}:/var/www/indies/nginx

      # 5Ô∏è‚É£ Deploy remoto
      - name: Deploy app
        run: |
          ssh -o StrictHostKeyChecking=no ${{ vars.SSH_USER }}@${{ vars.SSH_HOST }} << 'EOF'
            set -e
            cd /var/www/indies

            echo "üîç Checking .env.production"
            test -f .env.production || {
              echo "‚ùå .env.production NOT FOUND"
              exit 1
            }

            CERTS_DIR="/var/lib/docker/volumes/infra_postgres-data/_data/certs"

            echo "üîê Ensuring Postgres SSL certificates"
            echo "üìÅ CERTS_DIR=$CERTS_DIR"

            mkdir -p "$CERTS_DIR"

            if [ ! -f "$CERTS_DIR/root.key" ]; then
              echo "üßæ Generating root CA"
              openssl genrsa -out "$CERTS_DIR/root.key" 4096
              openssl req -x509 -new -nodes \
                -key "$CERTS_DIR/root.key" \
                -sha256 -days 3650 \
                -subj "/CN=Postgres Root CA" \
                -out "$CERTS_DIR/root.crt"
            fi

            if [ ! -f "$CERTS_DIR/server.key" ]; then
              echo "üîë Generating server key"
              openssl genrsa -out "$CERTS_DIR/server.key" 4096
            fi

            if [ ! -f "$CERTS_DIR/server.csr" ]; then
              echo "üìÑ Generating server CSR"
              openssl req -new \
                -key "$CERTS_DIR/server.key" \
                -subj "/CN=postgres" \
                -out "$CERTS_DIR/server.csr"
            fi

            if [ ! -f "$CERTS_DIR/server.crt" ]; then
              echo "üìú Signing server certificate"
              openssl x509 -req \
                -in "$CERTS_DIR/server.csr" \
                -CA "$CERTS_DIR/root.crt" \
                -CAkey "$CERTS_DIR/root.key" \
                -CAcreateserial \
                -out "$CERTS_DIR/server.crt" \
                -days 3650 -sha256
            fi

            echo "üîí Fixing permissions"
            chown -R 999:999 "$CERTS_DIR"
            chmod 700 "$CERTS_DIR"
            chmod 600 "$CERTS_DIR/server.key"
            chmod 644 "$CERTS_DIR/server.crt" "$CERTS_DIR/root.crt"

            echo "‚úÖ Postgres SSL certificates ready"

            echo "üîç Checking nginx config files"
            test -f nginx/indies.http.conf || {
              echo "‚ùå indies.http.conf NOT FOUND"
              exit 1
            }

            test -f nginx/indies.https.conf || {
              echo "‚ùå indies.https.conf NOT FOUND"
              exit 1
            }

            docker load < indies-app.tar.gz
            docker compose -f compose.yaml up -d --no-deps indies-app

            echo "üîÑ Reloading nginx"
            if docker ps -a --format '{{.Names}}' | grep -q '^nginx$'; then
              echo "‚è≥ Waiting for nginx to be running..."

              for i in {1..15}; do
                STATUS=$(docker inspect -f '{{.State.Status}}' nginx 2>/dev/null || true)

                if [ "$STATUS" = "running" ]; then
                  docker exec nginx nginx -s reload
                  echo "‚úÖ nginx reloaded"
                  break
                fi

                echo "‚è≥ nginx status: $STATUS (retry $i)"
                sleep 2
              done
            else
              echo "‚ÑπÔ∏è nginx container not found, skipping reload"
            fi
          EOF

      # Run Migrations
      #- name: Run database migrations
      #  run: |
      #    ssh -o StrictHostKeyChecking=no ${{ vars.SSH_USER }}@${{ vars.SSH_HOST }} <<EOF
      #    cd /var/www/indies
      #    docker exec indies-app npx node-pg-migrate -m infra/migrations up
      #    EOF
