name: Deploy Indies Brasil

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@a6f90b1f127823b31d4d4a8d96047790581349bd
        with:
          ssh-private-key: ${{ secrets.SSH_KEY }}

      - name: Deploy to VPS
        env:
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_HOST: ${{ secrets.SSH_HOST }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          CLOUDINARY_CLOUD_NAME: ${{ secrets.CLOUDINARY_CLOUD_NAME }}
          CLOUDINARY_API_KEY: ${{ secrets.CLOUDINARY_API_KEY }}
          CLOUDINARY_API_SECRET: ${{ secrets.CLOUDINARY_API_SECRET }}
          SESSION_SECRET: ${{ secrets.SESSION_SECRET }}
          PEPPER: ${{ secrets.PEPPER }}
          NEXT_PUBLIC_SITE_NAME: ${{ secrets.NEXT_PUBLIC_SITE_NAME }}
          NEXT_PUBLIC_BASE_URL: ${{ secrets.NEXT_PUBLIC_BASE_URL }}
          POSTGRES_HOST: ${{ secrets.POSTGRES_HOST }}
          POSTGRES_PORT: ${{ secrets.POSTGRES_PORT }}
          POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          EMAIL_SMTP_HOST: ${{ secrets.EMAIL_SMTP_HOST }}
          EMAIL_SMTP_PORT: ${{ secrets.EMAIL_SMTP_PORT }}
          EMAIL_SMTP_USER: ${{ secrets.EMAIL_SMTP_USER }}
          EMAIL_SMTP_PASSWORD: ${{ secrets.EMAIL_SMTP_PASSWORD }}
          FILE_UPLOAD_BASE_FOLDER: ${{ secrets.FILE_UPLOAD_BASE_FOLDER }}

        run: |
          ssh -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST << 'EOF'
            cd /var/www/indies || exit 1

            git pull origin main

            cat > .env.production << EOL
            NODE_ENV=production
            
            PORT=$PORT
            
            SESSION_SECRET=$SESSION_SECRET
            PEPPER=$PEPPER
            NEXT_PUBLIC_SITE_NAME=$NEXT_PUBLIC_SITE_NAME
            NEXT_PUBLIC_BASE_URL=$NEXT_PUBLIC_BASE_URL
            
            POSTGRES_HOST=$POSTGRES_HOST
            POSTGRES_PORT=$POSTGRES_PORT
            POSTGRES_DB=$POSTGRES_DB
            POSTGRES_USER=$POSTGRES_USER
            POSTGRES_PASSWORD=$POSTGRES_PASSWORD
            DATABASE_URL=$DATABASE_URL
            
            EMAIL_SMTP_HOST=$EMAIL_SMTP_HOST
            EMAIL_SMTP_PORT=$EMAIL_SMTP_PORT
            EMAIL_SMTP_USER=$EMAIL_SMTP_USER
            EMAIL_SMTP_PASSWORD=$EMAIL_SMTP_PASSWORD
            FILE_UPLOAD_BASE_FOLDER=$FILE_UPLOAD_BASE_FOLDER

            CLOUDINARY_CLOUD_NAME=$CLOUDINARY_CLOUD_NAME
            CLOUDINARY_API_KEY=$CLOUDINARY_API_KEY
            CLOUDINARY_API_SECRET=$CLOUDINARY_API_SECRET

            EOL

            docker compose build
            docker compose up -d

            docker image prune -f
          EOF
